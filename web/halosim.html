<html><head><base href="https://fuffypanda.world/"><title>3D Multiplayer Character Controller with Chat</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script><script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script><script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script><style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background-color: #1a1a1a;
    color: #ffffff;
    overflow: hidden;
  }
  #canvas-container {
    width: 100vw;
    height: 100vh;
  }
  #loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: #fff;
  }
  #error-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    color: #ff4444;
    text-align: center;
    display: none;
  }
  #instructions {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.7);
    padding: 10px;
    border-radius: 5px;
    font-size: 14px;
    text-align: center;
  }
  #login-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #login-form {
    background-color: #333;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
  }
  #username-input {
    margin: 10px 0;
    padding: 5px;
    width: 200px;
  }
  #login-button {
    margin-top: 10px;
    padding: 5px 10px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #joystick-container {
    position: absolute;
    bottom: 20px;
    left: 20px;
    width: 100px;
    height: 100px;
    z-index: 1000;
  }
  #jump-button {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    z-index: 1000;
  }
  #settings-button {
    position: absolute;
    top: 20px;
    right: 20px;
    padding: 5px 10px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: 5px;
    cursor: pointer;
    z-index: 1000;
  }
  #settings-menu {
    position: absolute;
    top: 60px;
    right: 20px;
    background-color: rgba(0, 0, 0, 0.7);
    padding: 20px;
    border-radius: 10px;
    display: none;
    z-index: 1000;
  }
  .settings-item {
    margin-bottom: 10px;
  }
  .settings-item label {
    display: inline-block;
    width: 200px;
  }
  #chat-container {
    position: absolute;
    bottom: 20px;
    left: 20px;
    width: 300px;
    background-color: rgba(0, 0, 0, 0.7);
    border-radius: 5px;
    padding: 10px;
    z-index: 1000;
  }
  #chat-messages {
    height: 150px;
    overflow-y: auto;
    margin-bottom: 10px;
  }
  #chat-input {
    width: 100%;
    padding: 5px;
    border: none;
    border-radius: 3px;
  }
</style></head><body>
  <div id="canvas-container"></div>
  <div id="loading">Loading 3D Model...</div>
  <div id="error-message"></div>
  <div id="instructions">
    WASD to move | Space to jump | Mouse to look around | Click to lock pointer | Enter to chat
  </div>
  <div id="login-overlay">
    <div id="login-form">
      <h2>Enter your username</h2>
      <input type="text" id="username-input" placeholder="Username">
      <button id="login-button">Join Game</button>
    </div>
  </div>
  <div id="joystick-container"></div>
  <div id="jump-button">Jump</div>
  <div id="settings-button">Settings</div>
  <div id="settings-menu">
    <div class="settings-item">
      <label for="invert-lr-movement">Invert Left/Right Movement</label>
      <input type="checkbox" id="invert-lr-movement" checked>
    </div>
    <div class="settings-item">
      <label for="invert-fb-movement">Invert Forward/Backward Movement</label>
      <input type="checkbox" id="invert-fb-movement" checked>
    </div>
    <div class="settings-item">
      <label for="invert-ud-camera">Invert Up/Down Camera</label>
      <input type="checkbox" id="invert-ud-camera">
    </div>
    <div class="settings-item">
      <label for="invert-lr-camera">Invert Left/Right Camera</label>
      <input type="checkbox" id="invert-lr-camera">
    </div>
  </div>
  <div id="chat-container">
    <div id="chat-messages"></div>
    <input type="text" id="chat-input" placeholder="Type your message...">
  </div>

  <script>
    let scene, camera, renderer, playerModel, mixer, clock;
    let currentAnimation = null;
    let animations = {};
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, isJumping = false;
    let velocity = new THREE.Vector3();
    let direction = new THREE.Vector3();
    let cameraOffset = new THREE.Vector3(0, 2, 5);
    let mouseSensitivity = 0.002;
    let cameraAngleX = 0;
    let cameraAngleY = 0;
    let jumpVelocity = 0;
    let gravity = -9.8;
    let username = '';
    let gun;
    let players = {};
    let joystick;
    let isMobile = false;
    let joystickMovement = new THREE.Vector2();
    let lastActivityTime = Date.now();

    // Settings
    let invertLRMovement = true;
    let invertFBMovement = true;
    let invertUDCamera = false;
    let invertLRCamera = false;

    const modelUrl = 'https://raw.githubusercontent.com/mrdoob/three.js/dev/examples/models/gltf/Soldier.glb';
    const GUN_PREFIX = 'fuffypanda.world_';

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('canvas-container').appendChild(renderer.domElement);

      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(0, 10, 10);
      scene.add(directionalLight);

      clock = new THREE.Clock();

      createSkybox();
      createFloor();
      loadModel();

      window.addEventListener('resize', onWindowResize, false);
      document.addEventListener('keydown', onKeyDown, false);
      document.addEventListener('keyup', onKeyUp, false);
      document.addEventListener('mousemove', onMouseMove, false);
      document.addEventListener('wheel', onMouseWheel, false);
      document.addEventListener('click', lockPointer, false);

      // Initialize GUN
      gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);

      document.getElementById('login-button').addEventListener('click', login);

      // Detect mobile and set up controls
      isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobile) {
        setupMobileControls();
      }

      // Prevent scrolling on mobile
      document.body.addEventListener('touchmove', function(e) {
        e.preventDefault();
      }, { passive: false });

      // Set up settings menu
      setupSettingsMenu();

      // Set up event listener for tab close
      window.addEventListener('beforeunload', removePlayer);

      // Set up chat
      setupChat();

      // Start the activity check interval
      setInterval(checkPlayerActivity, 5000);
    }

    function createSkybox() {
      const loader = new THREE.CubeTextureLoader();
      const texture = loader.load([
        'https://threejsfundamentals.org/threejs/resources/images/cubemaps/computer-history-museum/pos-x.jpg',
        'https://threejsfundamentals.org/threejs/resources/images/cubemaps/computer-history-museum/neg-x.jpg',
        'https://threejsfundamentals.org/threejs/resources/images/cubemaps/computer-history-museum/pos-y.jpg',
        'https://threejsfundamentals.org/threejs/resources/images/cubemaps/computer-history-museum/neg-y.jpg',
        'https://threejsfundamentals.org/threejs/resources/images/cubemaps/computer-history-museum/pos-z.jpg',
        'https://threejsfundamentals.org/threejs/resources/images/cubemaps/computer-history-museum/neg-z.jpg',
      ]);
      scene.background = texture;
    }

    function setupSettingsMenu() {
      const settingsButton = document.getElementById('settings-button');
      const settingsMenu = document.getElementById('settings-menu');

      settingsButton.addEventListener('click', () => {
        settingsMenu.style.display = settingsMenu.style.display === 'none' ? 'block' : 'none';
      });

      document.getElementById('invert-lr-movement').addEventListener('change', (e) => {
        invertLRMovement = e.target.checked;
      });

      document.getElementById('invert-fb-movement').addEventListener('change', (e) => {
        invertFBMovement = e.target.checked;
      });

      document.getElementById('invert-ud-camera').addEventListener('change', (e) => {
        invertUDCamera = e.target.checked;
      });

      document.getElementById('invert-lr-camera').addEventListener('change', (e) => {
        invertLRCamera = e.target.checked;
      });
    }

    function setupMobileControls() {
      joystick = nipplejs.create({
        zone: document.getElementById('joystick-container'),
        mode: 'static',
        position: { left: '50px', bottom: '50px' },
        color: 'white',
        size: 100
      });

      joystick.on('move', function(evt, data) {
        const angle = data.angle.radian;
        const force = Math.min(data.force, 1);

        joystickMovement.x = Math.cos(angle) * force;
        joystickMovement.y = Math.sin(angle) * force;

        moveForward = joystickMovement.y > 0.1;
        moveBackward = joystickMovement.y < -0.1;
        moveLeft = joystickMovement.x < -0.1;
        moveRight = joystickMovement.x > 0.1;
      });

      joystick.on('end', function() {
        joystickMovement.set(0, 0);
        moveForward = moveBackward = moveLeft = moveRight = false;
      });

      document.getElementById('jump-button').addEventListener('touchstart', jump);
    }

    function setupChat() {
      const chatInput = document.getElementById('chat-input');
      chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          const message = chatInput.value.trim();
          if (message) {
            sendChatMessage(message);
            chatInput.value = '';
          }
        }
      });

      gun.get(GUN_PREFIX + 'chat').map().on(function(message, id) {
        if (message) {
          addChatMessage(message);
        }
      });
    }

    function sendChatMessage(message) {
      gun.get(GUN_PREFIX + 'chat').set({
        username: username,
        message: message,
        timestamp: Date.now()
      });
    }

    function addChatMessage(message) {
      const chatMessages = document.getElementById('chat-messages');
      const messageElement = document.createElement('div');
      messageElement.textContent = `${message.username}: ${message.message}`;
      chatMessages.appendChild(messageElement);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function login() {
      username = document.getElementById('username-input').value.trim();
      if (username) {
        document.getElementById('login-overlay').style.display = 'none';
        initializePlayer();
      }
    }

    function initializePlayer() {
      gun.get(GUN_PREFIX + 'players').get(username).put({
        x: 0,
        y: 0,
        z: 0,
        rotationY: 0,
        animation: 'Idle',
        lastActive: Date.now()
      });

      gun.get(GUN_PREFIX + 'players').map().on(function(data, key) {
        if (key !== username) {
          if (!players[key]) {
            loadOtherPlayer(key, data);
          } else {
            updateOtherPlayer(key, data);
          }
        }
      });
    }

    function loadOtherPlayer(playerName, initialData) {
      const loader = new THREE.GLTFLoader();
      loader.load(modelUrl, (gltf) => {
        const playerModel = gltf.scene;
        scene.add(playerModel);
        playerModel.position.set(initialData.x, initialData.y, initialData.z);
        playerModel.rotation.y = initialData.rotationY;

        const nameSprite = createNameSprite(playerName);
        playerModel.add(nameSprite);

        const mixer = new THREE.AnimationMixer(playerModel);
        const animations = {};
        gltf.animations.forEach((clip) => {
          animations[clip.name] = mixer.clipAction(clip);
        });

        players[playerName] = {
          model: playerModel,
          nameSprite: nameSprite,
          mixer: mixer,
          animations: animations,
          currentAnimation: null,
          lastActive: initialData.lastActive
        };

        updateOtherPlayer(playerName, initialData);
      });
    }

    function updateOtherPlayer(playerName, data) {
      const player = players[playerName];
      if (player) {
        player.model.position.set(data.x, data.y, data.z);
        player.model.rotation.y = data.rotationY;
        player.lastActive = data.lastActive;

        if (data.animation && data.animation !== player.currentAnimation) {
          if (player.currentAnimation) {
            player.animations[player.currentAnimation].fadeOut(0.5);
          }
          player.currentAnimation = data.animation;
          player.animations[data.animation].reset().fadeIn(0.5).play();
        }
      }
    }

    function removePlayer() {
      if (username) {
        gun.get(GUN_PREFIX + 'players').get(username).put(null);
      }
    }

    function createNameSprite(name) {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.width = 256;
      canvas.height = 64;
      context.font = '24px Arial';
      context.fillStyle = 'white';
      context.textAlign = 'center';
      context.fillText(name, 128, 32);

      const texture = new THREE.Texture(canvas);
      texture.needsUpdate = true;

      const material = new THREE.SpriteMaterial({ map: texture });
      const sprite = new THREE.Sprite(material);
      sprite.position.y = 2.5;
      sprite.scale.set(2, 0.5, 1);

      return sprite;
    }

    function createFloor() {
      const planeSize = 1000;
      const texture = new THREE.TextureLoader().load('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACklEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==');
      texture.wrapS = THREE.RepeatWrapping;
      texture.wrapT = THREE.RepeatWrapping;
      texture.repeat.set(planeSize, planeSize);

      const planeGeo = new THREE.PlaneGeometry(planeSize, planeSize);
      const planeMat = new THREE.MeshPhongMaterial({
        map: texture,
        side: THREE.DoubleSide,
      });
      const mesh = new THREE.Mesh(planeGeo, planeMat);
      mesh.rotation.x = Math.PI * -.5;
      scene.add(mesh);

      const gridHelper = new THREE.GridHelper(planeSize, planeSize, 0x00ff00, 0x006400);
      scene.add(gridHelper);
    }

    function loadModel() {
      const loader = new THREE.GLTFLoader();
      const loadingElement = document.getElementById('loading');
      const errorElement = document.getElementById('error-message');

      loadingElement.style.display = 'block';
      errorElement.style.display = 'none';

      loader.load(modelUrl, (gltf) => {
        playerModel = gltf.scene;
        scene.add(playerModel);

        playerModel.scale.set(1, 1, 1);
        playerModel.position.set(0, 0, 0);

        const nameSprite = createNameSprite(username);
        playerModel.add(nameSprite);

        mixer = new THREE.AnimationMixer(playerModel);
        animations = {};
        gltf.animations.forEach((clip) => {
          animations[clip.name] = mixer.clipAction(clip);
        });

        loadingElement.style.display = 'none';
        
        playAnimation('Idle');

        updateCameraPosition();
      }, undefined, (error) => {
        console.error('An error occurred while loading the model:', error);
        loadingElement.style.display = 'none';
        errorElement.style.display = 'block';
        errorElement.textContent = 'Error loading the 3D model. Please try again later.';
      });
    }

    function playAnimation(animationName, loop = true) {
      if (currentAnimation) {
        currentAnimation.fadeOut(0.5);
      }
      currentAnimation = animations[animationName];
      if (currentAnimation) {
        currentAnimation.reset().fadeIn(0.5).play();
        currentAnimation.loop = loop ? THREE.LoopRepeat : THREE.LoopOnce;
      }
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function onKeyDown(event) {
      if (!username) return;
      switch (event.code) {
        case 'KeyW': moveForward = true; break;
        case 'KeyS': moveBackward = true; break;
        case 'KeyA': moveLeft = true; break;
        case 'KeyD': moveRight = true; break;
        case 'Space': jump(); break;
      }
      lastActivityTime = Date.now();
    }

    function onKeyUp(event) {
      if (!username) return;
      switch (event.code) {
        case 'KeyW': moveForward = false; break;
        case 'KeyS': moveBackward = false; break;
        case 'KeyA': moveLeft = false; break;
        case 'KeyD': moveRight = false; break;
      }
    }

    function jump() {
      if (!isJumping) {
        isJumping = true;
        jumpVelocity = 5;
        playAnimation('Jump', false);
      }
      lastActivityTime = Date.now();
    }

    function onMouseMove(event) {
      if (!username || isMobile) return;
      if (document.pointerLockElement === document.body) {
        const movementX = event.movementX * (invertLRCamera ? -1 : 1);
        const movementY = event.movementY * (invertUDCamera ? -1 : 1);
        cameraAngleY -= movementX * mouseSensitivity;
        cameraAngleX += movementY * mouseSensitivity;
        cameraAngleX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraAngleX));
        updateCameraPosition();
      }
      lastActivityTime = Date.now();
    }

    function onMouseWheel(event) {
      if (!username || isMobile) return;
      const zoomSpeed = 0.1;
      cameraOffset.z += event.deltaY * zoomSpeed * 0.01;
      cameraOffset.z = Math.max(2, Math.min(10, cameraOffset.z));
      updateCameraPosition();
      lastActivityTime = Date.now();
    }

    function updateCameraPosition() {
      const theta = cameraAngleY;
      const phi = cameraAngleX;

      camera.position.x = playerModel.position.x + cameraOffset.z * Math.sin(theta) * Math.cos(phi);
      camera.position.y = playerModel.position.y + cameraOffset.z * Math.sin(phi) + 2;
      camera.position.z = playerModel.position.z + cameraOffset.z * Math.cos(theta) * Math.cos(phi);

      camera.lookAt(playerModel.position);
    }

    function lockPointer() {
      if (!username || isMobile) return;
      document.body.requestPointerLock();
    }

    function checkPlayerActivity() {
      const currentTime = Date.now();
      if (currentTime - lastActivityTime > 120000) { // 2 minutes
        playAnimation('Idle');
      }

      // Remove inactive players
      for (const playerName in players) {
        if (currentTime - players[playerName].lastActive > 120000) {
          removeInactivePlayer(playerName);
        }
      }
    }

    function removeInactivePlayer(playerName) {
      if (players[playerName]) {
        scene.remove(players[playerName].model);
        delete players[playerName];
        gun.get(GUN_PREFIX + 'players').get(playerName).put(null);
      }
    }

    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      if (mixer) mixer.update(delta);

      // Update other players' animations
      for (const playerName in players) {
        if (players[playerName].mixer) {
          players[playerName].mixer.update(delta);
        }
      }

      if (username && playerModel) {
        velocity.x = 0;
        velocity.z = 0;

        if (isMobile) {
          direction.set(joystickMovement.x, 0, -joystickMovement.y).normalize();
        } else {
          direction.z = Number(moveForward) - Number(moveBackward);
          direction.x = Number(moveLeft) - Number(moveRight);
          direction.normalize();
        }

        // Apply invert settings
        direction.x *= invertLRMovement ? -1 : 1;
        direction.z *= invertFBMovement ? -1 : 1;

        const speed = 5.0;
        velocity.z = direction.z * speed * delta;
        velocity.x = direction.x * speed * delta;

        // Rotate velocity vector based on camera rotation
        velocity.applyAxisAngle(new THREE.Vector3(0, 1, 0), cameraAngleY);

        // Apply gravity and jump
        if (isJumping) {
          playerModel.position.y += jumpVelocity * delta;
          jumpVelocity += gravity * delta;
          if (playerModel.position.y <= 0) {
            playerModel.position.y = 0;
            isJumping = false;
            jumpVelocity = 0;
          }
        }

        playerModel.position.add(velocity);

        // Make the model face the direction of movement
        if (velocity.length() > 0) {
          const targetRotation = Math.atan2(-velocity.x, -velocity.z);
          playerModel.rotation.y = targetRotation;
        }

        updateCameraPosition();

        // Update animation based on movement
        let currentAnimationName = 'Idle';
        if (isJumping) {
          currentAnimationName = 'Jump';
        } else if (velocity.length() > 0) {
          currentAnimationName = 'Walk';
        }

        if (currentAnimation !== animations[currentAnimationName]) {
          playAnimation(currentAnimationName, currentAnimationName !== 'Jump');
        }

        // Update player position and animation in GUN
        gun.get(GUN_PREFIX + 'players').get(username).put({
          x: playerModel.position.x,
          y: playerModel.position.y,
          z: playerModel.position.z,
          rotationY: playerModel.rotation.y,
          animation: currentAnimationName,
          lastActive: Date.now()
        });
      }

      renderer.render(scene, camera);
    }

    init();
    animate();
  </script>
</body></html>